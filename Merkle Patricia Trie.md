以太坊的 **Merkle Patricia Trie（MPT）** 是一种结合了 **Merkle Tree** 和 **Patricia Trie（前缀树）** 的混合数据结构，用于高效存储和验证区块链中的状态、交易和收据数据。它是以太坊数据结构的核心，确保了数据的不可篡改性、快速查询和轻节点验证能力。


## **1. MPT 的核心组成**

MPT 融合了两种经典数据结构的优势：

- **Merkle Tree**：通过哈希树结构实现数据的密码学验证（任何修改都会改变根哈希）。
    
- **Patricia Trie（压缩前缀树）**：通过共享前缀压缩存储，减少空间占用，加快查找速度。
    

---

## **2. Merkle Patricia Trie 的结构**

MPT 的节点分为四种类型：

### **(1) 空节点（Empty Node）**

- 表示空值或未初始化的节点。
    

### **(2) 叶子节点（Leaf Node）**

- 存储实际的键值对（Key-Value）。
    
- 格式：`[encodedPath, value]`
    
    - `encodedPath` 是键的十六进制编码（带特殊前缀标识叶子节点）。
        
    - `value` 是对应的数据（如账户状态、交易内容等）。
        

### **(3) 扩展节点（Extension Node）**

- 用于压缩共享前缀的路径。
    
- 格式：`[sharedPrefix, nextNode]`
    
    - `sharedPrefix` 是多个子节点共有的路径前缀。
        
    - `nextNode` 指向下一个子节点（可能是分支节点或叶子节点）。
        

### **(4) 分支节点（Branch Node）**

- 表示一个16叉树节点（对应16个可能的16进制字符 `0-f` + 1个Value存储位）。
    
- 格式：`[child0, child1, ..., child15, value]`
    
    - 每个 `child` 指向下一个节点（可能为空）。
        
    - `value` 可存储当前路径的终止值（如果有）。
        

---

## **3. MPT 的关键特性**

### **(1) 确定性根哈希**

- 任何数据的修改都会导致根哈希变化，确保数据不可篡改。
    
- 区块头中的 `stateRoot`、`transactionsRoot`、`receiptsRoot` 都是MPT的根哈希。
    

### **(2) 高效查找**

- 通过路径压缩（前缀树特性），减少存储和查询时间。
    
    - 例如，键 `0x1234` 和 `0x1256` 共享 `0x12` 前缀，存储时只需存一次。
        

### **(3) 支持轻节点验证**

- 轻节点（如手机钱包）只需存储区块头，通过 **Merkle Proof** 验证某笔交易或状态是否存在。
    

### **(4) 增量更新**

- 状态树（State Trie）在新区块产生时只修改受影响的部分，而非重建整个树，提升效率。
    

---

## **4. MPT 在以太坊中的应用**

### **(1) 状态树（State Trie）**

- 存储所有账户的当前状态（余额、Nonce、合约代码等）。
    
- 键：账户地址（20字节）的 Keccak256 哈希。
    
- 值：账户状态的 RLP 编码。
    

### **(2) 交易树（Transactions Trie）**

- 每个区块的交易列表，键是交易索引（RLP编码），值是交易数据。
    

### **(3) 收据树（Receipts Trie）**

- 存储交易执行后的收据（Gas消耗、日志等），键同样是交易索引。
    

---

## **5. MPT 的运作示例**

假设我们要存储以下键值对：

Copy

("0x1234", "value1")  
("0x1235", "value2")  
("0x5678", "value3")

MPT 的构建过程：

1. **共享前缀**：`0x1234` 和 `0x1235` 共享 `0x123`。
    
2. **分支节点**：在 `0x123` 处分叉（`4` 和 `5` 指向不同叶子节点）。
    
3. **存储优化**：`0x5678` 单独存储为叶子节点。
    

最终结构：

Copy

Root
├── ExtensionNode("0x123", ...)
│   ├── BranchNode
│   │   ├── child4 → LeafNode("", "value1")
│   │   ├── child5 → LeafNode("", "value2")
├── LeafNode("0x5678", "value3")

---

## **6. 为什么以太坊选择 MPT？**

|需求|MPT 的解决方案|
|---|---|
|**快速状态验证**|Merkle 特性确保根哈希可验证|
|**高效存储**|Patricia Trie 压缩路径减少空间占用|
|**支持动态更新**|增量修改，避免全量重建|
|**兼容轻客户端**|Merkle Proof 实现部分数据验证|

---

## **总结**

- **MPT = Merkle Tree + Patricia Trie**，兼顾安全性与高效性。
    
- 用于存储以太坊的 **状态、交易、收据**，确保数据可验证且不可篡改。
    
- 通过 **路径压缩、分支节点、哈希链** 实现快速查询和更新。
    

MPT 是以太坊能够支持智能合约、去中心化应用（DApp）和轻客户端的关键基础设施！