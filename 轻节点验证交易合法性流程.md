**轻节点**验证交易的合法性需要依赖全节点，具体流程如下：

轻节点通过 **SPV（Simplified Payment Verification，简单支付验证）** 机制来验证交易的合法性。以下是具体的流程：

首先轻节点会将希望验证的交易的哈希值发送给全节点，然后全节点会执行以下步骤：
#### （1）**查找交易**

- 全节点会在本地的区块链数据中查找该交易哈希值对应的交易。
    
- 由于全节点存储了完整的区块链数据（包括所有区块和交易），它可以通过索引快速定位交易所在的区块。
    

#### （2）**生成默克尔证明**

- 全节点会从默克尔树中提取该交易的 **默克尔证明**。
    
- 默克尔证明包括：
    
    - 该交易的哈希值。
        
    - 从该交易到默克尔根哈希值的路径上所有相关节点的哈希值。
        
- 例如，假设默克尔树的结构如下：
    
    Copy
    
         Root
        /    \
       H1     H2
      / \    / \
     H3 H4  H5 H6
     |  |   |  |
    T1 T2  T3 T4
    
    如果轻节点请求验证交易 T1，全节点会提供以下默克尔证明：
    
    - T1 的哈希值。
        
    - H4（T1 的兄弟节点）。
        
    - H2（H1 的兄弟节点）。
        

#### （3）**返回交易数据和默克尔证明**

- 全节点会将以下信息返回给轻节点：
    
    - 交易数据。
        
    - 该交易所在的区块头。
        
    - 默克尔证明。
        

---

### 3. **轻节点如何验证默克尔证明**

轻节点收到全节点返回的数据后，会执行以下步骤来验证交易是否存在于区块中：

#### （1）**计算交易的哈希值**

- 轻节点首先计算收到的交易数据的哈希值，确保它与发送的交易哈希值（TXID）一致。
    

#### （2）**重建默克尔根哈希**

- 轻节点使用默克尔证明中的哈希值，逐步计算默克尔根哈希。
    
- 例如，使用前面的默克尔树例子：
    
    1. 计算 T1 和 H4 的哈希值，生成 H1。
        
    2. 计算 H1 和 H2 的哈希值，生成 Root。
        
- 如果计算出的默克尔根哈希与区块头中的默克尔根哈希一致，说明交易确实存在于该区块中。
    

#### （3）**验证区块头**

- 轻节点会检查区块头是否存在于自己的区块链副本中。
    
- 轻节点会验证区块头的工作量证明（PoW），确保该区块是由矿工合法生成的。
    

#### （4）**确认交易合法性**

- 如果默克尔根哈希匹配，并且区块头有效，轻节点可以确认该交易确实存在于区块中。
    
- 轻节点还可以检查该区块是否被足够多的后续区块确认（通常需要 6 个确认）。